/**
 * Music Industry Simulator - Exploitation Abilities System
 *
 * Provides temporary boosts through "exploitation" tactics:
 * - Bot streams
 * - Playlist placement
 * - Viral marketing
 * - Influencer promotions
 *
 * KEY MECHANICS:
 * - Abilities cost money (scaling with use)
 * - Provide temporary multipliers (30-120 seconds)
 * - Types: income, fans, speed
 * - Multiple boosts can be active simultaneously
 * - Costs increase each use to prevent spam
 */

import type { GameState, ActiveBoost, ExploitationAbility } from '$lib/game/types';

/**
 * All exploitation abilities
 */
export const EXPLOITATION_ABILITIES: ExploitationAbility[] = [
	{
		id: 'bot_streams',
		name: 'Bot Streams',
		description: 'Deploy streaming bots for 2x income (60s)',
		baseCost: 1000,
		costScaling: 1.5,
		duration: 60,
		multiplier: 2.0,
		type: 'income',
		timesUsed: 0
	},
	{
		id: 'playlist_placement',
		name: 'Playlist Placement',
		description: 'Buy playlist spots for 3x fans (45s)',
		baseCost: 2500,
		costScaling: 1.5,
		duration: 45,
		multiplier: 3.0,
		type: 'fans',
		timesUsed: 0
	},
	{
		id: 'viral_marketing',
		name: 'Viral Marketing',
		description: 'Create viral content for 4x income (30s)',
		baseCost: 5000,
		costScaling: 1.5,
		duration: 30,
		multiplier: 4.0,
		type: 'income',
		timesUsed: 0
	},
	{
		id: 'influencer_promo',
		name: 'Influencer Promo',
		description: 'Pay influencers for 5x fans (30s)',
		baseCost: 10000,
		costScaling: 1.5,
		duration: 30,
		multiplier: 5.0,
		type: 'fans',
		timesUsed: 0
	},
	{
		id: 'ai_optimization',
		name: 'AI Optimization',
		description: 'AI-optimized content for 3x speed (120s)',
		baseCost: 25000,
		costScaling: 1.5,
		duration: 120,
		multiplier: 3.0,
		type: 'speed',
		timesUsed: 0
	}
];

/**
 * Get ability by ID
 */
export function getAbility(id: string): ExploitationAbility | undefined {
	return EXPLOITATION_ABILITIES.find((a) => a.id === id);
}

/**
 * Calculate current cost for an ability
 */
export function calculateAbilityCost(ability: ExploitationAbility, timesUsed: number): number {
	return Math.floor(ability.baseCost * Math.pow(ability.costScaling, timesUsed));
}

/**
 * Check if player can use ability
 */
export function canUseAbility(state: GameState, abilityId: string): boolean {
	const ability = getAbility(abilityId);
	if (!ability) return false;

	// Check if already active
	if (state.activeBoosts.some((b) => b.abilityId === abilityId)) {
		return false;
	}

	// Check if can afford
	const cost = calculateAbilityCost(ability, ability.timesUsed);
	return state.money >= cost;
}

/**
 * Use an exploitation ability
 */
export function useAbility(state: GameState, abilityId: string): boolean {
	if (!canUseAbility(state, abilityId)) {
		return false;
	}

	const ability = getAbility(abilityId);
	if (!ability) return false;

	// Calculate cost
	const cost = calculateAbilityCost(ability, ability.timesUsed);

	// Deduct cost
	state.money -= cost;

	// Create active boost
	const boost: ActiveBoost = {
		abilityId: ability.id,
		name: ability.name,
		multiplier: ability.multiplier,
		expiresAt: Date.now() + ability.duration * 1000,
		type: ability.type
	};

	// Add to active boosts
	state.activeBoosts.push(boost);

	// Increment times used
	ability.timesUsed += 1;

	console.log(`[Exploitation] Used ${ability.name} - ${ability.multiplier}x for ${ability.duration}s`);
	return true;
}

/**
 * Process active boosts (remove expired)
 */
export function processBoosts(state: GameState): void {
	const now = Date.now();

	// Filter out expired boosts
	const expired = state.activeBoosts.filter((b) => b.expiresAt <= now);
	state.activeBoosts = state.activeBoosts.filter((b) => b.expiresAt > now);

	// Log expired boosts
	for (const boost of expired) {
		console.log(`[Exploitation] ${boost.name} expired`);
	}
}

/**
 * Get total multiplier for a type
 */
export function getBoostMultiplier(state: GameState, type: 'income' | 'fans' | 'speed'): number {
	let multiplier = 1.0;

	for (const boost of state.activeBoosts) {
		if (boost.type === type) {
			multiplier *= boost.multiplier;
		}
	}

	return multiplier;
}

/**
 * Get all active boosts of a type
 */
export function getActiveBoosts(
	state: GameState,
	type?: 'income' | 'fans' | 'speed'
): ActiveBoost[] {
	if (type) {
		return state.activeBoosts.filter((b) => b.type === type);
	}
	return state.activeBoosts;
}
