<!--
  Exploitation Panel Component

  Displays available exploitation abilities and allows activating them.
  Shows active boosts and their remaining duration.
-->
<script lang="ts">
	import type { GameState } from '$lib/game/types';
	import { formatMoney, formatDuration } from '$lib/game/utils';
	import { EXPLOITATION_ABILITIES, useAbility, calculateAbilityCost, getAbility } from '$lib/systems/exploitation';

	let { gameState = $bindable() }: { gameState: GameState } = $props();

	// Get active boosts with time remaining
	const activeBoosts = $derived(() => {
		const now = Date.now();
		return gameState.activeBoosts.filter(boost => boost.expiresAt > now);
	});

	function handleActivate(abilityId: string) {
		useAbility(gameState, abilityId);
	}

	function getBoostColor(type: string): string {
		switch (type) {
			case 'income': return 'text-green-400';
			case 'fans': return 'text-pink-400';
			case 'speed': return 'text-blue-400';
			default: return 'text-gray-400';
		}
	}

	function getBoostIcon(type: string): string {
		switch (type) {
			case 'income': return 'ðŸ’°';
			case 'fans': return 'ðŸ‘¥';
			case 'speed': return 'âš¡';
			default: return 'âœ¨';
		}
	}
</script>

<div class="exploitation-panel bg-game-panel p-6 rounded-lg shadow-lg border border-gray-800">
	<h2 class="text-2xl font-bold mb-4 text-game-accent flex items-center gap-2">
		ðŸŽ¯ Exploitation & Boosts
	</h2>

	<!-- Active Boosts -->
	{#if activeBoosts().length > 0}
		<div class="active-boosts mb-4">
			<h3 class="text-sm font-bold text-gray-400 mb-2">Active Boosts</h3>
			<div class="space-y-2">
				{#each activeBoosts() as boost}
					<div class="boost-item bg-gray-800 p-3 rounded-lg flex justify-between items-center">
						<div class="flex items-center gap-2">
							<span class="text-xl">{getBoostIcon(boost.type)}</span>
							<div>
								<p class="font-bold {getBoostColor(boost.type)}">{boost.name}</p>
								<p class="text-xs text-gray-400">{boost.multiplier}x multiplier</p>
							</div>
						</div>
						<div class="text-right">
							<p class="text-sm font-bold text-purple-300">
								{formatDuration(boost.expiresAt - Date.now())}
							</p>
							<p class="text-xs text-gray-400">remaining</p>
						</div>
					</div>
				{/each}
			</div>
		</div>
	{/if}

	<!-- Available Abilities -->
	<div class="abilities-grid grid grid-cols-1 md:grid-cols-2 gap-3">
		{#each EXPLOITATION_ABILITIES as ability}
			{@const cost = calculateAbilityCost(ability, ability.timesUsed)}
			{@const canAfford = gameState.money >= cost}

			<button
				onclick={() => handleActivate(ability.id)}
				disabled={!canAfford}
				class="ability-card text-left p-4 rounded-lg transition-all border {canAfford ? 'bg-gray-800 hover:bg-gray-700 border-gray-700 hover:border-purple-500' : 'bg-gray-900 border-gray-800 opacity-50 cursor-not-allowed'}"
			>
				<div class="flex justify-between items-start mb-2">
					<div>
						<p class="font-bold text-purple-300">{ability.name}</p>
						<p class="text-xs {getBoostColor(ability.type)}">{ability.type} boost</p>
					</div>
					<span class="text-2xl">{getBoostIcon(ability.type)}</span>
				</div>

				<p class="text-xs text-gray-400 mb-3">{ability.description}</p>

				<div class="flex justify-between items-center text-xs">
					<div>
						<span class="text-green-400 font-bold">{ability.multiplier}x</span>
						<span class="text-gray-400"> for {formatDuration(ability.duration * 1000)}</span>
					</div>
					<div class="text-right">
						<p class="font-bold text-yellow-400">{formatMoney(cost)}</p>
						<p class="text-gray-500">{ability.timesUsed > 0 ? `(used ${ability.timesUsed}x)` : ''}</p>
					</div>
				</div>
			</button>
		{/each}
	</div>

	<p class="text-xs text-gray-500 mt-4 text-center">
		ðŸ’¡ Tip: Costs increase with each use to prevent spam
	</p>
</div>
